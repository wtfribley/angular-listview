!function(e){"use strict";var t=e.$$minErr("listview");e.module("listview",["ngAnimate"]).factory("listViewParser",["$parse",function(e){var i=/^\s*([\s\S]+?)\s+in\s+([\s\S]+?)(?:\s+track\s+by\s+([\s\S]+?))?\s*$/,n=/^(?:([\$\w]+)|\(([\$\w]+)\s*,\s*([\$\w]+)\))$/;return{parse:function(s){var r=s.match(i);if(!r)throw new t("iexp","Expected expression in form of '_item_ in _collection_ (track by _id_)?' but got '{0}'.",s);var l=r[2],o=r[1];if(r=o.match(n),!r)throw new t("iidexp","'_item_' in '_item_ in _collection_' should be an identifier or '(_key_, _value_)' expression, but got '{0}'.",o);return{collectionMapper:e(l),keyIdentifier:r[2]||"$index"}}}}]).controller("ListViewCtrl",["$animate",function(e){this.selectMode="none",this.selectElements=[],this.parserResult=null,this.$element=null,this.inEditMode=!1,this.select=function(t){var i=this.selectMode;if("none"!=i){if("single"==i||"active"==i)for(var n=0,s=this.selectElements.length;s>n;n++)e.removeClass(this.selectElements[n],"selected");e.addClass(t,"selected"),"active"==i&&e.addClass(t,"active")}},this.deselect=function(t){t.hasClass("active")&&e.removeClass(t,"active"),e.removeClass(t,"selected")},this.registerSelectElement=function(e){var t=this.selectElements;return t.push(e),function(){t.splice(t.indexOf(e),1)}},this.toggleEditMode=function(){this.editMode=!this.editMode;var t=this.editMode?"addClass":"removeClass";e[t](this.$element,"edit-mode")},this.remove=function(e){var t=this.parserResult;return function(){var i,n=t.collectionMapper(e),s=e.$eval(t.keyIdentifier);Array.isArray(n)?i=n.splice(s,1)[0]:(i=n[s],delete n[s]),e.$emit("listview.remove",i,n)}}}]).directive("listView",["listViewParser",function(e){function t(e){return e.tagName&&(e.hasAttribute("list-item")||e.hasAttribute("data-list-item")||"list-item"===e.tagName.toLowerCase()||"data-list-item"===e.tagName.toLowerCase())}var i={single:"single",multi:"multi",active:"active",none:"none"};return{restrict:"EA",controller:"ListViewCtrl",compile:function(n,s){for(var r,l=n.contents(),o=0,c=l.length;c>o;o++)if(t(l[o])){r=l.eq(o);break}return r.attr("ng-repeat",s.list),function(t,n,s,r){r.selectMode=i[s.selectMode]||"none",r.parserResult=e.parse(s.list),r.$element=n}}}}]).directive("listEdit",["$parse","$q",function(e,t){return{restrict:"A",require:"^listView",link:function(i,n,s,r){var l=s.editOn||"click",o=s.listEdit?e(s.listEdit):function(){return!0};n.on(l,function(e){return e.stopPropagation(),r.inEditMode?r.toggleEditMode():void t.when(o(i,{$event:e})).then(function(e){e!==!1&&r.toggleEditMode()})})}}}]).directive("listAdd",function(){return{restrict:"A",require:"^listView",link:function(){}}}).directive("listItem",["$parse","$q","$timeout",function(e,t,i){return{restrict:"EA",require:"^listView",link:function(n,s,r,l){var o="none"==l.selectMode?null:r.selectOn||"click";if(o){var c=function(){return!0},a=null,u=l.registerSelectElement(s);n.$on("$destroy",u),r.selectFn&&(c=e(r.selectFn)),s.on(o,function(e){if(e.stopPropagation(),"click"==o){var r=!a;i.cancel(a),a=i(function(){a=null},300)}else r=!0;if(r){if(s.hasClass("selected"))return l.deselect(s);t.when(c(n,{$event:e})).then(function(e){e!==!1&&l.select(s)})}})}}}}]).directive("listItemEdit",["$parse",function(t){return{restrict:"A",require:"^listView",link:function(i,n,s,r){var l=s.editOn||"click",o=s.listItemEdit||e.noop;"delete"==o||"remove"==o?o=r.remove(i):"string"==typeof o&&(o=t(o)),n.on(l,function(e){e.stopPropagation(),i.$apply(function(){o(i,{$event:e})})})}}}])}(angular);